<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªÜ TH·ªêNG AI T∆Ø T∆Ø·ªûNG QK7</title>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=76Y2N6U7"></script>
    <style>
        :root { --army-green: #1a2f1a; --bright-yellow: #ffeb3b; --red-flag: #f44336; }
        body { background-color: var(--army-green); color: #e0e0e0; font-family: 'Segoe UI', Arial, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background-color: #0e1a0e; padding: 10px; text-align: center; border-bottom: 2px solid var(--bright-yellow); }
        .voice-controls { background: #243b24; padding: 8px; display: flex; justify-content: center; gap: 15px; font-size: 0.8rem; align-items: center; border-bottom: 1px solid #3e5a3e; }
        select, input[type="range"] { background: #1a2f1a; color: white; border: 1px solid var(--bright-yellow); border-radius: 3px; }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; background-image: radial-gradient(#2d4f2d 1px, transparent 1px); background-size: 20px 20px; }
        .message { padding: 12px 18px; border-radius: 10px; max-width: 80%; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .user { background-color: #2d4f2d; align-self: flex-end; border-right: 5px solid #4caf50; }
        .ai { background-color: #263238; align-self: flex-start; border-left: 5px solid var(--red-flag); }
        
        #input-group { padding: 15px; background-color: #0e1a0e; display: flex; gap: 10px; align-items: center; }
        #user-input { flex: 1; padding: 12px; border-radius: 5px; border: 1px solid #388e3c; background: #ffffff; color: #000; font-weight: 500; }
        
        /* N√∫t Micro */
        .mic-btn { background-color: #d32f2f; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 20px; transition: 0.3s; }
        .mic-btn.recording { background-color: #ff5252; box-shadow: 0 0 15px #ff5252; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        button#send-btn { background-color: #388e3c; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size: 1.1rem; color: var(--bright-yellow); text-transform: uppercase;">Chuy√™n Gia T∆∞ T∆∞·ªüng Qu√¢n Khu 7</h1>
</header>

<div class="voice-controls">
    <label>Gi·ªçng ƒë·ªçc:</label>
    <select id="voice-select">
        <option value="Vietnamese Male">Nam b·ªô (M·∫°nh m·∫Ω)</option>
        <option value="Vietnamese Female">N·ªØ b·ªô (Truy·ªÅn c·∫£m)</option>
    </select>
    <label>T·ªëc ƒë·ªô:</label>
    <input type="range" id="voice-rate" min="0.5" max="1.5" step="0.1" value="1">
</div>

<div id="chat-window">
    <div class="message ai">B√°o c√°o ƒë·ªìng ch√≠! T√¥i ƒë√£ s·∫µn s√†ng tr·ª±c chi·∫øn. ƒê·ªìng ch√≠ c√≥ th·ªÉ nh·∫•n n√∫t Micro ƒë·ªÉ ra l·ªánh b·∫±ng gi·ªçng n√≥i ho·∫∑c nh·∫≠p vƒÉn b·∫£n.</div>
</div>

<div id="input-group">
    <button id="mic-btn" class="mic-btn" onclick="startListening()" title="H·ªèi b·∫±ng gi·ªçng n√≥i">üé§</button>
    <input type="text" id="user-input" placeholder="N√≥i ho·∫∑c nh·∫≠p b√°o c√°o..." autocomplete="off">
    <button id="send-btn" onclick="send()">G·ª¨I</button>
</div>

<script>
    const API_URL = 'https://chatbot-tu-tuong.onrender.com/api/chat';

    // 1. CH·ª®C NƒÇNG NH·∫¨N DI·ªÜN GI·ªåNG N√ìI (Speech-to-Text)
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'vi-VN';
        recognition.interimResults = false;

        recognition.onstart = () => {
            document.getElementById('mic-btn').classList.add('recording');
            document.getElementById('user-input').placeholder = "ƒêang l·∫Øng nghe ƒë·ªìng ch√≠...";
        };

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            document.getElementById('user-input').value = transcript;
            send(); // T·ª± ƒë·ªông g·ª≠i sau khi n√≥i xong
        };

        recognition.onerror = () => {
            stopMic();
            alert("B√°o c√°o: Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i. M·ªùi ƒë·ªìng ch√≠ ki·ªÉm tra l·∫°i Micro.");
        };

        recognition.onend = () => { stopMic(); };

        function startListening() {
            try { recognition.start(); } catch(e) { recognition.stop(); }
        }

        function stopMic() {
            document.getElementById('mic-btn').classList.remove('recording');
            document.getElementById('user-input').placeholder = "N√≥i ho·∫∑c nh·∫≠p b√°o c√°o...";
        }
    } else {
        document.getElementById('mic-btn').style.display = 'none';
        console.log("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ nh·∫≠n di·ªán gi·ªçng n√≥i.");
    }

    // 2. CH·ª®C NƒÇNG G·ª¨I V√Ä PH·∫¢N H·ªíI (AI + Text-to-Speech)
    async function send() {
        const input = document.getElementById('user-input');
        const chatWindow = document.getElementById('chat-window');
        const btn = document.getElementById('send-btn');
        const text = input.value.trim();

        if (!text) return;

        btn.disabled = true;
        chatWindow.innerHTML += `<div class="message user"><b>ƒê·ªìng ch√≠:</b> ${text}</div>`;
        input.value = '';
        chatWindow.scrollTop = chatWindow.scrollHeight;

        try {
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_input: text })
            });
            const data = await res.json();
            const reply = data.response;

            chatWindow.innerHTML += `<div class="message ai"><b>Chuy√™n gia:</b> ${reply}</div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight;

            // ƒê·ªçc c√¢u tr·∫£ l·ªùi
            const selectedVoice = document.getElementById('voice-select').value;
            const selectedRate = document.getElementById('voice-rate').value;
            responsiveVoice.speak(reply, selectedVoice, {rate: selectedRate, pitch: 1});

        } catch (e) {
            chatWindow.innerHTML += `<div class="message ai" style="color:var(--red-flag)">B√°o c√°o: M·∫•t k·∫øt n·ªëi s·ªü ch·ªâ huy!</div>`;
        } finally {
            btn.disabled = false;
        }
    }

    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') send();
    });
</script>

</body>
</html>
